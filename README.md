# Реализация системы учета и анализа данных 
Сервис реализован с помощью фреймворка FastAPI, SQLAlchemy, Alembic и СУБД PostgreSQL. Запуск приложения происходит через Docker.  
Также проведено нагрузочное тестирование через инструмент locust, его результаты можно посмотреть в _locust_report.html_ или _locust_report.pdf_ в корне репозитория.

Начало работы
---
1. Склонировать к себе репозиторий, запустить docker daemon.
2. Перейти в папку _/docker_
3. Выполнить команды:  
`docker compose build`  
`docker compose up -d`

4. Для завершения работы выполнить:  
`docker compose down`

Доступные запросы
---
Система использует хост `0.0.0.0` с портом `8000` (http://0.0.0.0:8000).  
Возможны следующие запросы к системе:
+ GET `/` - Приветственное сообщение.
+ POST `/add_user` - Добавление нового пользователя.  
В теле запроса необходимо указать логин и пароль:  
    ```
    {
        "login": "superlogin",
        "password": "mypass"
    }
    ```
    При указании уже существующего логина, вернёт ошибку HTTP 409.
+ POST `/login` - Аутентификация пользователя по протоколу OAuth2.  
Проверяет наличие логина и пароля в БД и в случае успеха возвращает _access_token_.  
В Swagger возможно авторизироваться через форму. Далее описание аутентификация через обычный запрос.  
    В заголовке необходимо указать:
    ```
    {
        "content-type": "application/x-www-form-urlencoded"
    }
    ```
    Тело запроса выглядит следующим образом:
    ```
    {
        "username": "login", 
        "password": "password"
    }
    ```
    Если пользователь с такими данными не найден, вернёт ошибку HTTP 403.
+ GET `/users/me` - Возвращает логин и пароль текущего пользователя по имеющемуся у него _access_token_.  
Доступен только для авторизированных пользователей, поэтому в заголовке запроса необходимо указать:  
    ```
    {
        "Authorization": "Bearer " + access_token,
    }
    ```
    В Swagger после авторизации этот запрос будет доступен сразу.  
    При неверном _access_token_ вернёт ошибку HTTP 404.
+ POST `/add_device` - Добавление нового устройства, привязанного к текущему пользователю.  
Для этого запроса так же необходима авторизация, поэтому в заголовке указывается то же самое, что и в прошлом запросе. В теле запроса указывается идентификатор устройства - уникальное целое число. Например:
    ```
    {
        "id": 123
    }
    ```
    Если _access_token_ не будет предоставлен, вернёт HTTP 403.  
    Если устройство с таким id уже существует, вернёт HTTP 409.
+ GET `/devices` - Вернёт список всех идентификаторов устройств в БД или ошибку HTTP 404, если нет ни одного устройства.
+ GET `/new_device_data/{id}` - Получение новых данных с устройства с идентификатором = _id_. Если такого устройства в БД не существует, вернёт ошибку HTTP 400.  
Данные с устройства имеют вид:  
    ```
    {
        "x": 0,
        "y": 0,
        "z": 0,
        "date": "2024-01-01T00:00:01"
    }
    ```
+ GET `/device_data_analysis` - Получение аналитики по колонкам (_x_, _y_, _z_) данных одного или нескольких устройств за определённый промежуток времени.  
Аналитика подразумевает следующие значения:
    * минимальное значение
    * максимальное значение
    * количество
    * сумма
    * медиана  

    Возможные следующие query-параметры:
    * `device_id` - Идентификатор устройства, для данных которого будет проведена аналитика.  
    При отсутвии этого параметра будет проведена аналитика по данным всех устройств.
    * `user_id` - Идентификатор пользователя, по всем данным всех устройств которого будет проведена аналитика.  
    При отсутвии этого параметра будет проведена аналитика по данным устройств всех пользователей.
    * `column` - Название колонки, по которой будет проведена аналитика. Возможные варианты: _x_, _y_, _z_.  
    При отсутствии этого параметра будет проведена аналитика по всем колонкам.
    * `begin` - Начало временного промежутка, по которому будет проведена аналитика, в формате YYYY-MM-DDThh:mm:ss.  
    При отсутствии этого параметра будет проведена аналитика по периоду, начинающемуся со времени первой записи в таблице данных для необходимых устройств.
    * `end` - Конец временного промежутка, по которому будет проведена аналитика, в формате YYYY-MM-DDThh:mm:ss.  
    При отсутствии этого параметра будет проведена аналитика по периоду, заканчивающимся временем последней записи в таблице данных для необходимых устройств.

Нагрузочное тестирование с locust
---
Для проведения нагрузочного тестирования необходимо: 
1. Перейти по ссылке http://0.0.0.0:8089
2. Выбрать классы и количество пользователей
3. Указать в поле _Host_: http://fastapi:8000

Список доступных классов и за что они отвечают:
* User - Базовый класс, от которого наследуются остальные. Добавляет пользователя, авторизирует его и добавляет ему одно устройство.
* Root - Пользователь делает запрос к `/`.
* GetCurrentUser - Пользователь получает данные о себе `/users/me`.
* NewDeviceData - Пользователь получает новые данные по идентификатору устройства id (`/new_device_data/{id}`), который он рандомно выбирает из списка идентификаторов, полученных запросом по адресу `/devices`.
* OneDeviceDA - Пользователь получает анализ данных по идентификатору устройства id (`/device_data_analysis/?device_id={id}`), который он рандомно выбирает из списка идентификаторов, полученных запросом по адресу `/devices`.
* UserDevicesDA - Пользователь получает анализ данных по своему идентификатору id пользователя `/device_data_analysis/?user_id={id}`.
* AllDevicesDA - Пользователь получает анализ по всем данным `/device_data_analysis`.

Полученные мной результаты нагрузочного тестирования можно посмотреть в _locust_report.html_ или _locust_report.pdf_ в корне репозитория.